<?xml version="1.0" encoding="UTF-8"?>
<!--
    Todo:
        * Enable modify button, when user clicks it shows the CustomRegistrarDlg.
        ** But instead of a Next button it should say Modify. Clicking it does the modification (after verify). Then show the finish screen.
        * Make uninstall ask if user is sure.
        * Revision number should be whole VersionNumber.
        
        * Test:
        ** Everythign with combos 32/64bit, xp, vista, 7, 8, 2003, 2003r2, 2008, 2008r2, 2012.
        ** Admin user, user with admin powers, normal user.
-->
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi">
    <?include Definitions.wxi ?>
	<Product Id="$(var.GuidProduct)" Name="!(loc.ProductName) $(var.VersionNumber)" Language="!(loc.LANG)"
             Version="$(var.VersionNumber)" Manufacturer="Robpol86" UpgradeCode="$(var.GuidUpgrade)">
		<Package Id="$(var.GuidPackage)" InstallerVersion="301" Compressed="yes" InstallScope="perMachine"
                 Keywords="!(loc.Keywords)" Description="!(loc.Description)" Comments="!(loc.Comments)" />
        <MediaTemplate EmbedCab="yes" />
        <MajorUpgrade DowngradeErrorMessage="A newer version of [ProductName] is already installed." />
		<Feature Id="ProductFeature" Title="UnofficialDDNS" Level="1">
			<ComponentGroupRef Id="ProductComponents" />
		</Feature>
        <UIRef Id="CustomDialogSet" />

        <!-- Properties and Variables. -->
        <Property Id="ARPNOREPAIR" Value="1" /> <!-- Repair won't restore custom registry values. -->
        <Property Id="MSIFASTINSTALL" Value="1" /> <!-- Don't set a restore point in Win7 and up. -->
        <Property Id="WIXUI_INSTALLDIR" Value="INSTALLDIR" />
        <Property Id="REGISTRAR_REGISTRAR" Secure="yes">
            <RegistrySearch Id="Registrar" Root="HKLM" Key="SOFTWARE\UnofficialDDNS" Type="raw" Name="Registrar" />
        </Property>
        <Property Id="REGISTRAR_USER" Secure="yes" Hidden="yes">
            <RegistrySearch Id="Username" Root="HKLM" Key="SOFTWARE\UnofficialDDNS" Type="raw" Name="Username" />
        </Property>
        <Property Id="REGISTRAR_TOKEN" Secure="yes" Hidden="yes">
            <RegistrySearch Id="ApiToken" Root="HKLM" Key="SOFTWARE\UnofficialDDNS" Type="raw" Name="ApiToken" />
        </Property>
        <Property Id="REGISTRAR_DOMAIN" Secure="yes">
            <RegistrySearch Id="Domain" Root="HKLM" Key="SOFTWARE\UnofficialDDNS" Type="raw" Name="Domain" />
        </Property>
        <WixVariable Id="WixUILicenseRtf" Value="LICENSE.rtf" />
        <WixVariable Id="WixUIBannerBmp" Value="bannrbmp.bmp" />
        <WixVariable Id="WixUIDialogBmp" Value="dlgbmp.bmp" />
	</Product>

	<Fragment>
		<Directory Id="TARGETDIR" Name="SourceDir">
			<Directory Id="ProgramFilesFolder">
				<Directory Id="INSTALLDIR" Name="UnofficialDDNS" />
			</Directory>
		</Directory>
	</Fragment>

	<Fragment>
		<ComponentGroup Id="ProductComponents" Directory="INSTALLDIR">
			<Component Id="MainExe" Guid="$(var.GuidMainExe)">
                <File Id="MainExe" Checksum="yes" KeyPath="yes"
                      Source="..\UnofficialDDNS\bin\$(var.Configuration)\UnofficialDDNS.exe" />
            </Component>
            <Component Id="QueryDLL" Guid="$(var.GuidQueryDLL)">
                <File Id="QueryDLL" Checksum="yes" KeyPath="yes"
                      Source="..\UDDNSQuery\bin\$(var.Configuration)\UDDNSQuery.dll" />
            </Component>
            <Component Id="JSONnetDll" Guid="$(var.GuidJSONnetDll)">
                <File Id="JSONnetDll" Checksum="yes" KeyPath="yes"
                      Source="..\UDDNSQuery\bin\$(var.Configuration)\Newtonsoft.Json.dll" />
			</Component>
            <Component Id="RegistryEntries" Guid="$(var.GuidRegistryEntries)">
                <RegistryKey Root="HKLM" Key="SOFTWARE\UnofficialDDNS" Action="createAndRemoveOnUninstall">
                    <RegistryValue Type="string" Name="Registrar" Value="[REGISTRAR_REGISTRAR]" />
                    <RegistryValue Type="string" Name="Username" Value="[REGISTRAR_USER]" />
                    <RegistryValue Type="string" Name="ApiToken" Value="[REGISTRAR_TOKEN]" />
                    <RegistryValue Type="string" Name="Domain" Value="[REGISTRAR_DOMAIN]" />
                </RegistryKey>
            </Component>
		</ComponentGroup>
	</Fragment>
</Wix>